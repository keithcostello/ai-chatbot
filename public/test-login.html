<!DOCTYPE html>
<html>
<head>
  <title>Test Login - Standard</title>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 600px; margin: 40px auto; padding: 20px; }
    h1 { color: #1e3a3a; }
    label { display: block; margin: 10px 0 5px; }
    input { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
    button { padding: 12px 24px; background: #5d8a6b; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
    button:hover { background: #4a7559; }
    #result { margin-top: 20px; padding: 15px; border-radius: 4px; white-space: pre-wrap; word-wrap: break-word; }
    .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
    .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
    .info { background: #cce5ff; border: 1px solid #b8daff; color: #004085; }
    h2 { margin-top: 30px; border-top: 1px solid #ccc; padding-top: 20px; }
    .cookie-display { background: #f5f5f5; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px; margin: 10px 0; }
  </style>
</head>
<body>
  <h1>Standard Login Test</h1>
  <p>This page tests the email/password login flow directly.</p>

  <form id="loginForm">
    <div>
      <label for="email">Email:</label>
      <input type="email" id="email" required placeholder="Enter your email">
    </div>
    <div>
      <label for="password">Password:</label>
      <input type="password" id="password" required placeholder="Enter your password">
    </div>
    <button type="submit">Login</button>
  </form>

  <div id="result"></div>

  <h2>Cookie Status (document.cookie)</h2>
  <p>This shows what JavaScript CAN see. HttpOnly cookies will NOT appear here.</p>
  <div id="cookieDisplay" class="cookie-display">Loading...</div>
  <button onclick="refreshCookies()">Refresh Cookie Display</button>

  <h2>Diagnostics</h2>
  <p>
    <button onclick="checkAuthAPI()">Check /api/auth/me</button>
    <button onclick="window.location.href='/test-dashboard.html'">Go to Test Dashboard</button>
  </p>
  <div id="authResult"></div>

  <script>
    // Display cookies on page load
    function refreshCookies() {
      const cookies = document.cookie;
      document.getElementById('cookieDisplay').textContent = cookies || '(No cookies visible to JavaScript - HttpOnly cookies are hidden)';
    }
    refreshCookies();

    // Login form submission
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const resultDiv = document.getElementById('result');

      resultDiv.className = 'info';
      resultDiv.textContent = 'Logging in...';

      try {
        const response = await fetch('/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password }),
          credentials: 'include' // Important: include cookies
        });

        const data = await response.json();

        if (response.ok) {
          resultDiv.className = 'success';
          resultDiv.textContent = 'SUCCESS!\n\nResponse:\n' + JSON.stringify(data, null, 2) + '\n\nRedirecting to test dashboard in 2 seconds...';
          refreshCookies(); // Show updated cookies
          setTimeout(() => window.location.href = '/test-dashboard.html', 2000);
        } else {
          resultDiv.className = 'error';
          resultDiv.textContent = 'FAILED (Status ' + response.status + ')\n\nResponse:\n' + JSON.stringify(data, null, 2);
        }
      } catch (err) {
        resultDiv.className = 'error';
        resultDiv.textContent = 'NETWORK ERROR:\n' + err.message;
      }
    });

    // Check auth API
    async function checkAuthAPI() {
      const authDiv = document.getElementById('authResult');
      authDiv.className = 'info';
      authDiv.textContent = 'Checking authentication...';

      try {
        const response = await fetch('/api/auth/me', {
          credentials: 'include'
        });
        const data = await response.json();

        if (response.ok) {
          authDiv.className = 'success';
          authDiv.textContent = 'AUTHENTICATED!\n\nUser:\n' + JSON.stringify(data, null, 2);
        } else {
          authDiv.className = 'error';
          authDiv.textContent = 'NOT AUTHENTICATED (Status ' + response.status + ')\n\nResponse:\n' + JSON.stringify(data, null, 2);
        }
      } catch (err) {
        authDiv.className = 'error';
        authDiv.textContent = 'ERROR:\n' + err.message;
      }
    }
  </script>
</body>
</html>
