<!DOCTYPE html>
<html>
<head>
  <title>Test Dashboard</title>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 700px; margin: 40px auto; padding: 20px; }
    h1 { color: #1e3a3a; }
    h2 { margin-top: 30px; border-top: 1px solid #ccc; padding-top: 20px; }
    h3 { color: #5d8a6b; }
    button { padding: 12px 24px; background: #5d8a6b; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; margin: 5px; }
    button:hover { background: #4a7559; }
    .danger { background: #dc3545; }
    .danger:hover { background: #c82333; }
    #status, #userInfo, #diagnostics { margin-top: 15px; padding: 15px; border-radius: 4px; white-space: pre-wrap; word-wrap: break-word; }
    .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
    .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
    .info { background: #cce5ff; border: 1px solid #b8daff; color: #004085; }
    .warning { background: #fff3cd; border: 1px solid #ffeeba; color: #856404; }
    .cookie-display { background: #f5f5f5; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px; margin: 10px 0; }
    .diagnostic-item { margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 4px; }
    .diagnostic-item strong { display: block; margin-bottom: 5px; }
  </style>
</head>
<body>
  <h1>Test Dashboard</h1>
  <p>This page checks authentication WITHOUT using hasSessionCookie().</p>

  <div id="status" class="info">Checking authentication...</div>
  <div id="userInfo"></div>

  <h2>Actions</h2>
  <button onclick="logout()" class="danger">Logout</button>
  <button onclick="window.location.href='/test-login.html'">Go to Login</button>
  <button onclick="window.location.href='/dashboard'">Go to Real Dashboard</button>
  <button onclick="window.location.reload()">Refresh Page</button>

  <h2>Cookie Analysis</h2>
  <p><strong>Key Finding:</strong> HttpOnly cookies are NOT visible to JavaScript (this is correct security behavior).</p>

  <h3>document.cookie (what JS can see):</h3>
  <div id="cookieDisplay" class="cookie-display">Loading...</div>

  <h3>hasSessionCookie() simulation:</h3>
  <div id="hasSessionResult" class="diagnostic-item"></div>

  <h2>Root Cause Analysis</h2>
  <div id="diagnostics" class="warning">
    <strong>THE BUG:</strong>

    The dashboard page uses hasSessionCookie() which checks document.cookie for 'session='.

    PROBLEM: The session cookie is HttpOnly, so JavaScript CANNOT see it!

    RESULT: hasSessionCookie() always returns FALSE, even when user IS authenticated.

    FIX: Remove hasSessionCookie() check. Instead, ALWAYS call /api/auth/me and trust the server response.
    The server CAN see HttpOnly cookies and will correctly report auth status.
  </div>

  <h2>API Test Results</h2>
  <div id="apiResults"></div>

  <script>
    // Show cookies visible to JS
    function refreshCookies() {
      const cookies = document.cookie;
      document.getElementById('cookieDisplay').textContent = cookies || '(No cookies visible - this is EXPECTED for HttpOnly cookies)';
    }

    // Simulate hasSessionCookie
    function hasSessionCookie() {
      if (typeof document === 'undefined') return false;
      return document.cookie.split(';').some(c => c.trim().startsWith('session='));
    }

    // Show hasSessionCookie result
    function showHasSessionResult() {
      const result = hasSessionCookie();
      const el = document.getElementById('hasSessionResult');
      el.innerHTML = '<strong>hasSessionCookie() returns: ' + result + '</strong><br>' +
        (result ?
          '<span style="color:green">Session cookie IS visible to JavaScript</span>' :
          '<span style="color:red">Session cookie is NOT visible (HttpOnly) - THIS IS THE BUG</span>');
    }

    // Check auth via API (the correct way)
    async function checkAuth() {
      const statusDiv = document.getElementById('status');
      const userDiv = document.getElementById('userInfo');
      const apiDiv = document.getElementById('apiResults');

      try {
        // Test /api/auth/me
        const meResponse = await fetch('/api/auth/me', { credentials: 'include' });
        const meData = await meResponse.json();

        // Test /api/auth/session (Auth.js native)
        let sessionData = null;
        try {
          const sessionResponse = await fetch('/api/auth/session', { credentials: 'include' });
          sessionData = await sessionResponse.json();
        } catch (e) {
          sessionData = { error: 'Session endpoint not available' };
        }

        // Show API results
        apiDiv.innerHTML = `
          <div class="diagnostic-item">
            <strong>/api/auth/me (custom endpoint):</strong>
            Status: ${meResponse.status}
            Response: ${JSON.stringify(meData, null, 2)}
          </div>
          <div class="diagnostic-item">
            <strong>/api/auth/session (Auth.js native):</strong>
            Response: ${JSON.stringify(sessionData, null, 2)}
          </div>
        `;

        if (meResponse.ok && meData.user) {
          statusDiv.className = 'success';
          statusDiv.innerHTML = '<strong>LOGGED IN</strong> - Server confirms authentication via HttpOnly cookie';
          userDiv.className = 'success';
          userDiv.innerHTML = '<strong>User Details:</strong>\n' + JSON.stringify(meData.user, null, 2);
        } else {
          statusDiv.className = 'error';
          statusDiv.innerHTML = '<strong>NOT LOGGED IN</strong> - No valid session found';
          userDiv.className = 'info';
          userDiv.textContent = 'Please log in to see user details.';
        }
      } catch (err) {
        statusDiv.className = 'error';
        statusDiv.textContent = 'ERROR checking auth: ' + err.message;
      }
    }

    // Logout
    async function logout() {
      try {
        await fetch('/api/auth/logout', {
          method: 'POST',
          credentials: 'include'
        });
        document.getElementById('status').className = 'info';
        document.getElementById('status').textContent = 'Logged out. Redirecting to login...';
        setTimeout(() => window.location.href = '/test-login.html', 1000);
      } catch (err) {
        document.getElementById('status').className = 'error';
        document.getElementById('status').textContent = 'Logout error: ' + err.message;
      }
    }

    // Initialize on page load
    refreshCookies();
    showHasSessionResult();
    checkAuth();
  </script>
</body>
</html>
